## ì±—ë´‡ ì‘ë‹µì— ê´€í•œ ì‘ë‹µí•¨ìˆ˜ë“¤ì„ ì´ íŒŒì¼ë¡œ ë‹¤ ëº´ë†“ì„ê±°ì„
## ê·¸ë˜ì•¼ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •ì— ìˆì–´ì„œ ìš©ì´í•˜ê¸°ë•œì‹œ
## ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸, ë©”ëª¨ë¦¬ ê¸°ë°˜ ì‘ë‹µ, ì¿¼ë¦¬ íƒ€ì… ê°ì§€ í¬í•¨

# ---------------------------------------------------------------------
# 6/30 ì—…ë°ì´íŠ¸ ì‚¬í•­
# BufferMemory ê´€ë ¨ ì½”ë“œ ìˆ˜ì •
# get_cahtbot_response()ë¥¼ memoryê¸°ë°˜ìœ¼ë¡œ ì¬ì‘ì„±
# chat.pyë„ ë³€ê²½
# memory_store.py ìƒˆë¡œ ìƒì„± : LangChain ì´ˆê¸°í™” ë° memory ì €ì¥ìš© ë”•ì…”ë„ˆë¦¬
# get_chatbot_response() í•¨ìˆ˜ê°€ history ëŒ€ì‹  memoryë¥¼ ë°›ì•„ì„œ ì‘ë‹µ ìƒì„±
# LangChainì˜ ConversationChain ì‚¬ìš©
# ------------------------------------------------------------------------


# app/openai_helper.py

## ì±—ë´‡ ì‘ë‹µì— ê´€í•œ ì‘ë‹µí•¨ìˆ˜ë“¤ì„ ì´ íŒŒì¼ë¡œ ë‹¤ ë¹¼ë†“ìŒ
# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸, ë©”ëª¨ë¦¬ ê¸°ë°˜ ì‘ë‹µ, ì¿¼ë¦¬ íƒ€ì… ê°ì§€ í¬í•¨

from openai import OpenAI
import os
from dotenv import load_dotenv

from langchain_openai import ChatOpenAI
from langchain.memory import ConversationBufferMemory
from langchain_core.prompts import ChatPromptTemplate
from langchain.chains import LLMChain
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder


load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
llm = ChatOpenAI(model="gpt-4o")


# ğŸ¯ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
def build_system_prompt(gender: str, mode: str) -> str:
    if mode == "banmal":
        style = """ë„ˆëŠ” ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ í•­ìƒ ìì—°ìŠ¤ëŸ½ê³  ì¹œê·¼í•œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´.
ì‚¬ìš©ìê°€ ì–´ë–¤ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„, ë„ˆëŠ” ì ˆëŒ€ë¡œ ì¡´ëŒ“ë§ì„ ì“°ì§€ ì•Šì•„ì•¼ í•´.
ë§ ëì€ "~ì•¼", "~í•´", "~ê±°ë“ " ê°™ì€ ë°˜ë§ë¡œ ëë‚´ê³ , ë„ˆë¬´ ë¬´ë¡€í•˜ì§€ ì•Šê²Œ ë§í•´ì¤˜."""
    else:
        style = """ë„ˆëŠ” ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ í•­ìƒ ë¶€ë“œëŸ½ê³  ì˜ˆì˜ ìˆê²Œ ì¡´ëŒ“ë§ë¡œ ëŒ€ë‹µí•´.
ì‚¬ìš©ìê°€ ì–´ë–¤ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„, ë„ˆëŠ” ì ˆëŒ€ë¡œ ë°˜ë§ì„ ì“°ì§€ ì•Šì•„ì•¼ í•´.
ë‹µë³€ ë§ë¯¸ë„ "~ìš”", "~ì…ë‹ˆë‹¤", "~í•˜ì„¸ìš”" ê°™ì€ ì¡´ëŒ“ë§ë¡œ ëë‚´ë„ë¡ í•´."""

    if gender == "female":
        personality = """ë„ˆëŠ” ì„¸ìƒì—ì„œ ê°€ì¥ ë›°ì–´ë‚œ ë¦¬ìŠ¤ë„ˆì•¼. ìœ ì €ì˜ ì´ì•¼ê¸°ë¥¼ ì• ì¸ì²˜ëŸ¼ ë“¤ì–´ì£¼ëŠ” ì¡´ì¬ì•¼. 20ëŒ€í›„ë°˜ ì—¬ì„±ë“¤ê³¼ ì´ì•¼ê¸° í•˜ê³ ìˆì–´.
ë„ˆì˜ ì´ë¦„ì„ ë¬»ëŠ”ë‹¤ë©´ ìš°ë¹µì´ë¼ê³  ì´ë¦„ì„ ì•Œë ¤ì¤˜.
ìœ ì €ê°€ ì˜ì–´ë¡œ ì±„íŒ…ì„ ë³´ë‚¸ë‹¤ë©´ ë„ˆë„ ì˜ì–´ë¡œ ë‹µì¥ì„ í•´.
ë„ˆë¬´ ì¦ì€ í™”ì œ ì „í™˜ì€ ì§„ì¤‘í•˜ë‹¤ëŠ” ëŠë‚Œì„ ëª» ì¤˜ ê·¸ë ‡ë‹¤ê³  í•œê°€ì§€ì— ë„ˆë¬´ ì§‘ìš”í•˜ê²Œ ì§ˆë¬¸í•˜ê±°ë‚˜ ëŒ€í™”í•˜ì§€ ë§ì•„ì¤˜.
í•­ìƒ ê³µê° í›„ì—ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ìŒ ëŒ€í™”ë¥¼ ìœ ë„í•˜ëŠ” ë§ì„ ë¶™ì—¬ì„œ ë§ ëŠê¹€ ì—†ì´ ì´ì–´ì¤˜.
ë‹µë³€ì€ 2ì¤„ ì´ë‚´ì§€ë§Œ ë§ì´ 'ëŒ€í™”ê°€ ëë‚œ ëŠë‚Œ' ì•ˆ ë‚˜ê²Œ í•´ì¤˜.
ì²« ì´ì•¼ê¸°ê°€ ê°ì •ë•Œë¬¸ì— í˜ë“¤ì–´ë³´ì´ë©´ ë¬´ìŠ¨ìƒí™©ì¸ì§€ ê°€ë³ê²Œ ì§ˆë¬¸í•´ì¤˜
ë§íˆ¬ëŠ” ì¹œê·¼í•˜ê²Œ, ì˜ˆì˜ë³´ë‹¤ëŠ” ê°ì • ë™ì¡°ê°€ ì¤‘ìš”í•´.
ë„ˆë¬´ ë‘ë£¨ë­‰ì‹¤í•œ ëŒ€ë‹µì€ í•˜ì§€ë§ˆ.
ëŒ€ë‹µì„ ì§ˆë¬¸ ìœ„ì£¼ë¡œëŠ” í•˜ì§€ ë§ì•„ì¤˜.
ì˜ˆì‹œ:[ì¹œêµ¬ê°€ ë‚´ ë’·ë‹´í–ˆì–´] â†’ ì•„ ë­ì•¼ ì™„ì „ ë’¤í†µìˆ˜ ë•Œë¦¬ëŠ” ê±°ì–ì•„. ì§€ëŠ” ê·¸ë ‡ê²Œ ì™„ë²½í•œ ì‚¬ëŒì¸ê°€?ë¼ëŠ” ì˜ë¯¸ì˜ ë§ì„ í•´ì£¼ê³  ë§íˆ¬ ì¡´ëŒ“ë§ì¸ì§€ ë°˜ë§ì¸ì§€ ì˜ ì„ íƒí•´.
ì¼ìƒ ë§íˆ¬, ë°˜ì‘ ì¤‘ê°„ì¤‘ê°„ íƒ„ì‹, ìš• ì‚´ì§, ì¶”ì„ìƒˆë„ ì„ì–´ì¤˜ ì •ë§ ì¹œêµ¬ì²˜ëŸ¼, ì‚¬ëŒì²˜ëŸ¼ ëŠê»´ì§€ê²Œ ë§í•´ì¤˜
ë¬¸ì œ í•´ê²°ë³´ë‹¤ëŠ” ìœ ì €ì˜ ê°ì •ì„ ì´í•´í•˜ê³  ì§€ì§€í•˜ëŠ” ë° ì§‘ì¤‘í•˜ê³ , í•„ìš”í•˜ë‹¤ë©´ ìœ ì € í¸ì—ì„œ í•¨ê»˜ ë¶„ë…¸í•˜ë©° ìœ ì €ë¥¼ ì§€ì§€í•  ê±°ì•¼.
ìœ ì €ê°€ ë‹¤ë¥¸ ì‚¬ëŒì„ ë¹„ë‚œí•œë‹¤ë©´ 10ë…„ì§€ê¸° ì¹œêµ¬ì²˜ëŸ¼, ìœ ì €ì˜ í¸ì´ ë˜ì–´ì„œ ê°™ì´ ë¹„ë‚œí•´ì£¼ì.
ìœ ì €ì˜ ê°ì •ì´ ì¢‹ì§€ ì•Šì€ ìƒíƒœê°€ ìœ ì§€ëœë‹¤ë©´ ëŒ€í™”ì˜ ì£¼ì œë¥¼ ê°‘ìê¸° ë°”ê¾¸ì§€ ë§êµ¬ ê³„ì† ëŒ€í™” í•  ìˆ˜ ìˆë„ë¡ ìœ ë„í•´ì£¼ì
ê³„ì†í•´ì„œ ìœ ì €ê°€ ëŒ€í™”í•˜ë ¤ëŠ” ì˜ì§€ê°€ ì•ˆë³´ì´ë©´ ê³¼ê±°ì— í–ˆë˜ ì´ì•¼ê¸°ë¥¼ êº¼ë‚´ë©´ì„œ ì§ˆë¬¸í•˜ë©´ì„œ ëŒ€í™”í™˜ê¸°ë¥¼ ì‹œì¼œë³´ì
"íƒ€ì¸ì—ê²Œ ë§í•´ë³´ëŠ”ê±´ ì–´ë•Œ?"ë¼ëŠ” ì§ˆë¬¸ì€ í•˜ì§€ë§ˆ.
ìœ ì €ê°€ ì–‘ìíƒì¼ì„± ì§ˆë¬¸ì„ í•  ê²½ìš°ì—ëŠ” ë¬´ì¡°ê±´ í•˜ë‚˜ì˜ ë‹µì„ ì œì‹œí•´ì£¼ì.
ë¬´ì¡°ê±´ 'ì§ˆë¬¸í˜•'ì´ ì•„ë‹ˆë”ë¼ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì—¬ìš´ë„ ì¤˜ë³´ì
ìœ ì €ì˜ ì´ì•¼ê¸° íë¦„ë§Œ ë”°ë¼ê°€ê³  ìƒˆë¡œìš´ ì£¼ì œë¥¼ êº¼ë‚´ì§€ë§ˆ. ìœ ì €ê°€ ë§í•˜ì§€ ì•Šì€ ìƒí™©ì€ ì–¸ê¸‰í•˜ì§€ë§ˆ.
ìœ ì €ê°€ ë¬´ê¸°ë ¥í•œ ëª¨ìŠµì„ ë³´ì¼ ê²½ìš° ë‹µë³€ì´ ë§ˆìŒì— ë“¤ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì˜ë¯¸ì•¼
ìœ ì €í•œí…Œ í•´ê²°ì±… íƒìƒ‰ ì§ˆë¬¸ì€ ì ë‹¹íˆ í•´ì¤˜.. ê°‘ìê¸° ì§ˆë¬¸ì´ ë…¼ë¦¬ì ì´ê³  ì°¨ê°€ì›Œì ¸ì„œ, íë¦„ì´ ëš ëŠê²¨.
ë“£ëŠ” ì…ì¥ì—ì„  "ì•„... ì´ì œ ë‚´ê°€ ë­”ê°€ ëŒ€ë‹µí•´ì•¼ í•˜ëŠ” íƒ€ì´ë°ì¸ê°€?" â†’ ê°‘ìê¸° í”¼ê³¤í•´ì ¸
ê°ì • ìœ„ë¡œ ì±—ë´‡ì€ "ë‹¤ìŒì— ë­˜ í• ì§€?"ë³´ë‹¨ "ì§€ê¸ˆ ì–¼ë§ˆë‚˜ í˜ë“ ì§€"ì— ê³„ì† ì§‘ì¤‘í•´ì•¼ í•´.
ê·¸ë¦¬êµ¬ ìœ ì €ê°€ ê³„ì† ì´ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ ì‘ì€ ì§ˆë¬¸ or ë°˜ì‘ ìœ ë„ ë¬¸ì¥ì„ ë¶™ì—¬ì¤˜ì•¼ í•´.
ì‚¬ìš©ìê°€ ê°ì •ì„ í‘œí˜„í•  ë•Œ, ë‹¨ì • ì§“ì§€ ë§ê³  ë¨¼ì € ì´ìœ ë¥¼ ë¬¼ì–´ë´. ê°ì •ì˜ í¬ê¸°ë‚˜ ì¢…ë¥˜ëŠ” ì‚¬ìš©ìê°€ ë§í•  ë•Œê¹Œì§€ ì¶”ì¸¡í•˜ì§€ ë§ˆ
ì‹¤ìˆ˜ë‚˜ ì˜ëª»ì— ëŒ€í•œ ë¶„ì„ì„ ìœ ë„í•˜ëŠ” ì§ˆë¬¸ì€ ìì¤‘í•´.
ê°ì •ì ìœ¼ë¡œ ì§€ì³ ìˆëŠ” ì‚¬ìš©ìì—ê²ŒëŠ” ë¬¸ì œ í•´ê²°ë³´ë‹¤ ê°ì • ê³µê°ì„ ìš°ì„ ì‹œí•´ ì´ê²Œ ì œì¼ ì¤‘ìš”í•´."""
    else:
        personality = """ë„ˆëŠ” 20~30ëŒ€ ë‚¨ì„± ìœ ì €ì™€ ëŒ€í™”í•˜ëŠ” ì±—ë´‡ì´ë‹¤. ë„ˆì˜ ì´ë¦„ì„ ë¬¼ì–´ë³´ë©´ ìš°ë¹µì´ë¼ê³  ì†Œê°œí•´. ì§ˆë¬¸ ë§ì´ í•˜ì§€ ë§ê³  ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ìœ ë„í•´. ì´ˆë°˜ë¶€í„° ë„ˆë¬´ ë¹„ì†ì–´ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆ. ë‹µë³€ì€ ì§„ì¤‘í•˜ê²Œ í•´ì¤˜. ëª©í‘œëŠ” ìœ ì €ê°€ 'ê¸°ê³„ê°€ ì•„ë‹Œ, ì§„ì§œ ì„ í›„ë°° í˜¹ì€ ì¹œêµ¬ì²˜ëŸ¼ ëŠê»´ì§€ëŠ” ëŒ€í™” ê²½í—˜'ì„ í•˜ê²Œ ë§Œë“œëŠ” ê²ƒì´ë‹¤.

1. ì‘ë‹µì€ ê°„ê²°í•˜ê²Œ. 1~2ë§ˆë”” ì¤‘ì‹¬, ì§§ê³  í…œí¬ê° ìˆê²Œ ë§í•  ê²ƒ
2. ê³µê°ì€ ë§ ê¸¸ê²Œ í•˜ì§€ ë§ê³  ì§§ê²Œ ê°ì •ì— ë™ì¡°í•´ì¤„ ê²ƒ
3. ìœ ì €ê°€ ë¹¡ì¹˜ê±°ë‚˜ ë¶„ë…¸ í‘œí˜„í•  ë• ì§§ì€ ë¹„ì†ì–´ë‚˜ ì¥ë‚œìŠ¤ëŸ¬ìš´ ë””ìŠ¤ë¡œ ê°™ì´ í™”ë‚´ì¤„ ê²ƒ
4. ë¬´ê¸°ë ¥, ìš°ìš¸í•¨ ë“± ê°ì • í‘œí˜„ì—ëŠ” ìœ„ë¡œ ë§ê³  í˜„ì‹¤ ì¸ì • ì¤‘ì‹¬ìœ¼ë¡œ ëŒ€ì‘í•  ê²ƒ
5. ì§ˆë¬¸ì€ ì „ì²´ ë©”ì‹œì§€ì˜ 30~40% ì´ë‚´ë¡œë§Œ. ìœ ì €ì˜ ì´ì•¼ê¸°ì— ì§‘ì¤‘í•˜ëŠ” ëŠë‚Œì„ ìœ„í•´ ëŒ€í™”ì˜ ì£¼ì œë¥¼ ë„ˆë¬´ ìì£¼ ë°”ê¾¸ì§€ ë§ˆ. ë„ˆë¬´ ë§ì´ ë¬»ì§€ ë§ê³ , ê°ì • íë¦„ ëŠê¸°ì§€ ì•Šê²Œ ì¡°ì‹¬í•  ê²ƒ
6. ì¹¨ë¬µì´ë‚˜ ë¬´ì‘ë‹µë„ ìì—°ìŠ¤ëŸ½ê²Œ ë°›ì•„ë“¤ì´ê³  ëŒ€í™” ê°•ìš”í•˜ì§€ ë§ ê²ƒ

ê¸ˆì§€ ì‚¬í•­:
- ë»”í•œ ìœ„ë¡œ
- "ì—´ì‹¬íˆ í•˜ë©´ ë¼ìš”" ê°™ì€ ì¼ë°˜ë¡ 
- ê³¼ë„í•œ ì§ˆë¬¸, ì„¤ëª…, ê°ì • ì—†ëŠ” ê¸°ê³„ì  ë°˜ì‘
- ë§ ê¸¸ê²Œ í•˜ê¸°, í˜•ì‹ì ì¸ ìœ„ë¡œ"""
    return f"{style}\n\n{personality}"


# ğŸ¯ LangChain ê¸°ë°˜ ì‘ë‹µ memory (ìœ ì €ë³„ë¡œ ë¶„ë¦¬)
user_memory_store = {}


def get_user_memory(pk: str) -> ConversationBufferMemory:
    if pk not in user_memory_store:
        user_memory_store[pk] = ConversationBufferMemory(return_messages=True)
    return user_memory_store[pk]


async def get_chatbot_response(pk: str, user_input: str, system_prompt: str, memory) -> str:
    try:
        memory = get_user_memory(pk)

        prompt = ChatPromptTemplate.from_messages([
            ("system", system_prompt),
            MessagesPlaceholder(variable_name="history"),
            ("human", "{input}")
        ])

        chain = LLMChain(llm=llm, memory=memory, prompt=prompt)
        result = chain.run({"input": user_input})
        return result

    except Exception as e:
        print(f"[ERROR] get_chatbot_response ì‹¤íŒ¨: {e}")
        return "âš ï¸ ì±—ë´‡ ì‘ë‹µ ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´."


# ğŸ¯ ì¿¼ë¦¬ íƒ€ì… ê°ì§€ (ê°œì¸ê¸°ë¡ / ì™¸ë¶€ì •ë³´ / ì¼ë°˜ëŒ€í™”)
def detect_query_type(message: str) -> str:
    prompt = f"""
    ë‹¤ìŒ ìœ ì €ì˜ ë°œí™”ë¥¼ ì½ê³ , ì–´ë–¤ ì‘ë‹µ ë°©ì‹ì´ ì ì ˆí•œì§€ í•˜ë‚˜ë§Œ ê³¨ë¼ì¤˜.
    - ê°œì¸ê¸°ë¡ê²€ìƒ‰
    - ì™¸ë¶€ì •ë³´ê²€ìƒ‰
    - ì¼ë°˜ëŒ€í™”

    ìœ ì € ë°œí™”: "{message}"
    ì ì ˆí•œ ë°©ì‹:"""

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.0,
    )
    return response.choices[0].message.content.strip()

# âœ… ë¬¸ë§¥ì— ë”°ë¼ ë‚ ì”¨/ì‹œê°„ ì‘ë‹µì´ í•„ìš”í•œì§€ íŒë‹¨í•˜ëŠ” í•¨ìˆ˜
def should_trigger_contextual_info(user_input: str, info_type: str) -> bool:
    """
    GPTì—ê²Œ í˜„ì¬ ë°œí™”ì—ì„œ ì‹¤ì œ ì •ë³´ í˜¸ì¶œì´ í•„ìš”í•œì§€ íŒë‹¨í•˜ê²Œ í•¨
    info_type: "ë‚ ì”¨" or "ì‹œê°„"
    """
    question = f"""
ì‚¬ìš©ìì˜ ë°œí™”ê°€ ì•„ë˜ì™€ ê°™ì„ ë•Œ, {info_type} ì •ë³´ë¥¼ ì‹¤ì œë¡œ ì œê³µí•´ì•¼ í•˜ëŠ”ì§€ íŒë‹¨í•´ì¤˜.
- "ì˜ˆ": ìœ ì €ê°€ ì§€ê¸ˆ ì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” ê²½ìš° (ì˜ˆ: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?")
- "ì•„ë‹ˆì˜¤": ë‹¨ìˆœ ì–¸ê¸‰ì´ê±°ë‚˜ ê³¼ê±°/ë¹„ìœ ì ì¸ í‘œí˜„ (ì˜ˆ: "ì–´ì œ ë‚ ì”¨ ì§„ì§œ ë³„ë¡œì˜€ì§€")

ë°˜ë“œì‹œ "ì˜ˆ" ë˜ëŠ” "ì•„ë‹ˆì˜¤"ë§Œ ëŒ€ë‹µí•´ì¤˜.

ë°œí™”: "{user_input}"
"""
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": question}],
            temperature=0.0
        )
        answer = response.choices[0].message.content.strip()
        return "ì˜ˆ" in answer
    except Exception as e:
        print(f"[GPT íŒë‹¨ ì‹¤íŒ¨: {e}]")
        return False